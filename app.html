<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Log</title>
    
    <!-- Load React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;
        const Icons = {
            ChevronLeft: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            ),
            ChevronRight: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="m9 18 6-6-6-6"/>
                </svg>
            ),
            Save: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
            ),
            Plus: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            ),
            X: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            ),
            Github: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/>
                    <path d="M9 18c-4.51 2-5-2-7-2"/>
                </svg>
            ),
            Loader2: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
                    className="animate-spin">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
            )
        };

        const GIST_FILENAME = 'daily-logs.json';

        function DailyLog() {
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('morning');
            const [newActivity, setNewActivity] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [token, setToken] = useState(localStorage.getItem('github_token') || '');
            const [gistId, setGistId] = useState(localStorage.getItem('gist_id') || '');
            
            const defaultSchedule = [
                { name: 'Morning review', time: '10:00', completed: false },
                { name: 'Exercise', time: '', completed: false },
                { name: 'Lunch break', time: '', completed: false },
                { name: 'Deep work session 1', time: '', completed: false },
                { name: 'Deep work session 2', time: '', completed: false },
                { name: 'Evening review', time: '17:00', completed: false }
            ];

            const [logData, setLogData] = useState({
                morning: {
                    objectives: ['', '', ''],
                    schedule: defaultSchedule,
                    notes: ''
                },
                evening: {
                    accomplished: '',
                    notes: '',
                    tomorrow: ''
                }
            });

            useEffect(() => {
                if (token && gistId) {
                    loadDataFromGist();
                }
            }, [currentDate, token, gistId]);

            const handleGithubAuth = async () => {
                const newToken = prompt('Please enter your GitHub personal access token:');
                if (newToken) {
                    setToken(newToken);
                    localStorage.setItem('github_token', newToken);
                    
                    try {
                        setIsLoading(true);
                        const existingGistId = await findExistingGist(newToken);
                        
                        if (existingGistId) {
                            setGistId(existingGistId);
                            localStorage.setItem('gist_id', existingGistId);
                        } else {
                            const newGistId = await createInitialGist(newToken);
                            setGistId(newGistId);
                            localStorage.setItem('gist_id', newGistId);
                        }
                    } catch (error) {
                        console.error('Error setting up Gist:', error);
                        alert('Failed to set up GitHub storage. Please check your token and try again.');
                    } finally {
                        setIsLoading(false);
                    }
                }
            };

            const findExistingGist = async (authToken) => {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${authToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch gists');
                
                const gists = await response.json();
                const dailyLogGist = gists.find(gist => 
                    gist.files[GIST_FILENAME] && 
                    gist.description === 'Daily Log Storage'
                );
                
                return dailyLogGist ? dailyLogGist.id : null;
            };

            const createInitialGist = async (authToken) => {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${authToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        description: 'Daily Log Storage',
                        public: false,
                        files: {
                            [GIST_FILENAME]: {
                                content: JSON.stringify({})
                            }
                        }
                    })
                });
                
                if (!response.ok) throw new Error('Failed to create gist');
                
                const data = await response.json();
                return data.id;
            };

            const loadDataFromGist = async () => {
                try {
                    setIsLoading(true);
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch gist');
                    
                    const data = await response.json();
                    const content = JSON.parse(data.files[GIST_FILENAME].content);
                    
                    if (content[currentDate]) {
                        setLogData(content[currentDate]);
                    } else {
                        setLogData({
                            morning: {
                                objectives: ['', '', ''],
                                schedule: defaultSchedule,
                                notes: ''
                            },
                            evening: {
                                accomplished: '',
                                notes: '',
                                tomorrow: ''
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert('Failed to load data from GitHub');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSave = async () => {
                if (!token || !gistId) {
                    alert('Please set up GitHub storage first');
                    return;
                }

                try {
                    setIsLoading(true);
                    
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch current gist');
                    
                    const data = await response.json();
                    const content = JSON.parse(data.files[GIST_FILENAME].content);
                    
                    content[currentDate] = logData;
                    
                    const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            files: {
                                [GIST_FILENAME]: {
                                    content: JSON.stringify(content)
                                }
                            }
                        })
                    });
                    
                    if (!updateResponse.ok) throw new Error('Failed to update gist');
                    
                    alert('Saved successfully!');
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert('Failed to save data to GitHub');
                } finally {
                    setIsLoading(false);
                }
            };

            const addActivity = () => {
                if (newActivity.trim()) {
                    setLogData({
                        ...logData,
                        morning: {
                            ...logData.morning,
                            schedule: [...logData.morning.schedule, 
                                { name: newActivity, time: '', completed: false }
                            ]
                        }
                    });
                    setNewActivity('');
                }
            };

            const removeActivity = (index) => {
                const newSchedule = [...logData.morning.schedule];
                newSchedule.splice(index, 1);
                setLogData({
                    ...logData,
                    morning: {
                        ...logData.morning,
                        schedule: newSchedule
                    }
                });
            };

            return (
                <div className="max-w-2xl mx-auto p-4">
                    {!token && (
                        <div className="mb-6 p-4 bg-yellow-50 rounded-lg">
                            <button
                                onClick={handleGithubAuth}
                                className="flex items-center justify-center w-full p-3 bg-gray-900 text-white rounded-lg"
                                disabled={isLoading}
                            >
                                <Icons.Github />
                                <span className="ml-2">Set Up GitHub Storage</span>
                            </button>
                        </div>
                    )}

                    <div className="flex items-center justify-between mb-6">
                        <button 
                            onClick={() => setCurrentDate(prev => {
                                const d = new Date(prev);
                                d.setDate(d.getDate() - 1);
                                return d.toISOString().split('T')[0];
                            })}
                            className="p-2 rounded-full hover:bg-gray-100"
                            disabled={isLoading}
                        >
                            <Icons.ChevronLeft />
                        </button>
                        <h2 className="text-xl font-bold">{new Date(currentDate).toLocaleDateString()}</h2>
                        <button 
                            onClick={() => setCurrentDate(prev => {
                                const d = new Date(prev);
                                d.setDate(d.getDate() + 1);
                                return d.toISOString().split('T')[0];
                            })}
                            className="p-2 rounded-full hover:bg-gray-100"
                            disabled={isLoading}
                        >
                            <Icons.ChevronRight />
                        </button>
                    </div>

                    <div className="flex mb-6">
                        <button
                            className={`flex-1 p-3 ${activeTab === 'morning' ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}
                            onClick={() => setActiveTab('morning')}
                        >
                            Morning Log
                        </button>
                        <button
                            className={`flex-1 p-3 ${activeTab === 'evening' ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}
                            onClick={() => setActiveTab('evening')}
                        >
                            Evening Log
                        </button>
                    </div>

                    {activeTab === 'morning' ? (
                        <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="font-bold mb-4">START DAY</h3>
                            <div className="mb-6">
                                <h4 className="font-semibold mb-2">Objectives</h4>
                                {logData.morning.objectives.map((obj, idx) => (
                                    <input
                                        key={idx}
                                        type="text"
                                        className="w-full mb-2 p-2 border rounded"
                                        value={obj}
                                        onChange={(e) => {
                                            const newObjectives = [...logData.morning.objectives];
                                            newObjectives[idx] = e.target.value;
                                            setLogData({
                                                ...logData,
                                                morning: {
                                                    ...logData.morning,
                                                    objectives: newObjectives
                                                }
                                            });
                                        }}
                                        placeholder={`Objective ${idx + 1}`}
                                    />
                                ))}
                            </div>

                            <div className="mb-6">
                                <h4 className="font-semibold mb-2">Schedule</h4>
                                {logData.morning.schedule.map((activity, idx) => (
                                    <div key={idx} className="flex items-center mb-2">
                                        <input
                                            type="checkbox"
                                            checked={activity.completed}
                                            onChange={(e) => {
                                                const newSchedule = [...logData.morning.schedule];
                                                newSchedule[idx] = {
                                                    ...activity,
                                                    completed: e.target.checked
                                                };
                                                setLogData({
                                                    ...logData,
                                                    morning: {
                                                        ...logData.morning,
                                                        schedule: newSchedule
                                                    }
                                                });
                                            }}
                                            className="mr-2"
                                        />
                                        <input
                                            type="time"
                                            value={activity.time}
                                            onChange={(e) => {
                                                const newSchedule = [...logData.morning.schedule];
                                                newSchedule[idx] = {
                                                    ...activity,
                                                    time: e.target.value
                                                };
                                                setLogData({
                                                    ...logData,
                                                    morning: {
                                                        ...logData.morning,
                                                        schedule: newSchedule
                                                    }
                                                });
                                            }}
                                            className="mr-2 p-1 border rounded"
                                        />
                                        <span className="flex-1">{activity.name}</span>
                                        {idx >= defaultSchedule.length && (
                                            <button
                                                onClick={() => removeActivity(idx)}
                                                className="ml-2 text-red-500"
                                            >
                                                <X size={16} />
                                            </button>
                                        )}
                                    </div>
                                ))}
                                <div className="flex items-center mt-4">
                                    <input
                                        type="text"
                                        value={newActivity}
                                        onChange={(e) => setNewActivity(e.target.value)}
                                        placeholder="Add new activity"
                                        className="flex-1 p-2 border rounded mr-2"
                                    />
                                    <button
                                        onClick={addActivity}
                                        className="p-2 bg-blue-500 text-white rounded"
                                    >
                                        <Icons.Plus />
                                    </button>
                                </div>
                            </div>

                            <div className="mb-6">
                                <h4 className="font-semibold mb-2">Notes</h4>
                                <textarea
                                    className="w-full h-32 p-2 border rounded"
                                    value={logData.morning.notes}
                                    onChange={(e) => setLogData({
                                        ...logData,
                                        morning: {
                                            ...logData.morning,
                                            notes: e.target.value
                                        }
                                    })}
                                    placeholder="Morning notes..."
                                />
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="font-bold mb-4">END DAY</h3>
                            <div className="mb-6">
                                <h4 className="font-semibold mb-2">What I accomplished/worked on/learned</h4>
                                <textarea
                                    className="w-full h-32 p-2 border rounded"
                                    value={logData.evening.accomplished}
                                    onChange={(e) => setLogData({
                                        ...logData,
                                        evening: {
                                            ...logData.evening,
                                            accomplished: e.target.value
                                        }
                                    })}
                                    placeholder="Today's accomplishments..."
                                />
                            </div>

                            <div className="mb-6">
                                <h4 className="font-semibold mb-2">Notes</h4>
                                <textarea
                                    className="w-full h-32 p-2 border rounded"
                                    value={logData.evening.notes}
                                    onChange={(e) => setLogData({
                                        ...logData,
                                        evening: {
                                            ...logData.evening,
                                            notes: e.target.value
                                        }
                                    })}
                                    placeholder="Evening notes..."
                                />
                            </div>

                            <div className="mb-6">
                                <h4 className="font-semibold mb-2">Todo Tomorrow</h4>
                                <textarea
                                    className="w-full h-32 p-2 border rounded"
                                    value={logData.evening.tomorrow}
                                    onChange={(e) => setLogData({
                                        ...logData,
                                        evening: {
                                            ...logData.evening,
                                            tomorrow: e.target.value
                                        }
                                    })}
                                    placeholder="Plans for tomorrow..."
                                />
                            </div>
                        </div>
                    )}

                    <button
                        onClick={handleSave}
                        disabled={isLoading || !token}
                        className="fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg flex items-center justify-center disabled:bg-gray-400"
                    >
                        {isLoading ? (
                            <Icons.Loader2 />
                        ) : (
                            <Icons.Save />
                        )}
                    </button>
                </div>
            );
        }

        // Mount the app
        const root = createRoot(document.getElementById('root'));
        root.render(<DailyLog />);
    </script>
</body>
</html>